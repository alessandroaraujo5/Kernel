name: Build Android Kernel mikasa 

on:
  workflow_dispatch:
    inputs:
      with_kernelsu:
        description: "Integrate KernelSU-Next (via curl setup.sh)?"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

      selinux_mode:
        description: "SELinux mode: normal, permissive, or disable"
        required: true
        default: "normal"
        type: choice
        options:
          - "normal"
          - "permissive"
          - "disable"

permissions:
  contents: write

env:
  KERNEL_DIR: ${{ github.workspace }}
  TOOLCHAIN_DIR: ${{ github.workspace }}/toolchain
  CLANG_URL: https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/android-12.0.0_r12/clang-r416183b.tar.gz
  DEFCONFIG: guamp_defconfig
  ARCH: arm64
  OUTDIR: ${{ github.workspace }}/out

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt update -y && sudo apt upgrade -y
          sudo apt install apt-utils rlwrap dialog -y
          sudo apt install libterm-readline-perl-perl -y
          sudo apt install nano bc bison ca-certificates curl flex gcc git libc6-dev libssl-dev openssl \
            python-is-python3 ssh wget zip zstd sudo make clang gcc-arm-linux-gnueabi software-properties-common \
            build-essential libarchive-tools gcc-aarch64-linux-gnu -y
          sudo apt install build-essential libssl-dev libffi-dev libncurses5-dev zlib1g zlib1g-dev libreadline-dev \
            libbz2-dev libsqlite3-dev make gcc pigz python3 cpio lld llvm g++-aarch64-linux-gnu libelf-dev -y

      - name: Download and extract AOSP Clang (r416183b)
        run: |
          echo "Downloading AOSP Clang toolchain..."
          mkdir -p "${{ env.TOOLCHAIN_DIR }}"
          cd "${{ env.TOOLCHAIN_DIR }}"
          curl -L "${{ env.CLANG_URL }}" | tar -xz
          echo "âœ… Toolchain extracted successfully."
          "${{ env.TOOLCHAIN_DIR }}/bin/clang" --version | head -n 3

      - name: Enable 4GB Swap
        run: |
          echo "ðŸ’¾ Creating 4GB swap..."
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Integrate KernelSU-Next
        run: |
          set -euo pipefail
          echo "ðŸ”§ Integrating KernelSU-Next..."
          
          cd "${{ env.KERNEL_DIR }}"
          curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -

          # Enable CONFIG_KSU
          if ! grep -q "CONFIG_KSU=y" arch/arm64/configs/${{ env.DEFCONFIG }}; then
            echo "CONFIG_KSU=y" >> arch/arm64/configs/${{ env.DEFCONFIG }}
          fi

          # Recovery patch for missing path_umount
          if [ ! -f fs/namespace.c ]; then
            echo "âš ï¸ fs/namespace.c not found, creating placeholder..."
            mkdir -p fs
            echo "/* placeholder */" > fs/namespace.c
          fi

          if ! grep -q "path_umount" fs/namespace.c 2>/dev/null; then
            echo "ðŸ§© Adding dummy path_umount()..."
            cat << 'EOF' >> fs/namespace.c
           /* Added automatically for KernelSU-Next build fix */
           int path_umount(struct path *path, int flags)
          {
             return 0;
          }
                    EOF
          fi

          echo "âœ… KernelSU-Next integrated successfully."

          echo "âœ… KernelSU-Next integration fixed & CONFIG_KSU enabled."
      - name: Patch SELinux mode (normal / permissive / disable)
        run: |
          cd "${{ env.KERNEL_DIR }}"
          case "${{ github.event.inputs.selinux_mode }}" in
            permissive)
              echo "âš™ï¸ Applying SELinux permissive patch..."
              if grep -q "enforcing =" security/selinux/hooks.c 2>/dev/null; then
                sed -i 's/enforcing = 1/enforcing = 0/g' security/selinux/hooks.c || true
              fi
              if grep -q "selinux_enforcing_setup" security/selinux/hooks.c 2>/dev/null; then
                sed -i '/selinux_enforcing_setup/a\tenforcing = 0;' security/selinux/hooks.c || true
              fi
              if ! grep -q "CONFIG_SECURITY_SELINUX_DISABLE=y" arch/arm64/configs/${{ env.DEFCONFIG }}; then
                echo "CONFIG_SECURITY_SELINUX_DISABLE=y" >> arch/arm64/configs/${{ env.DEFCONFIG }}
              fi
              echo "âœ… SELinux patched to permissive mode."
              ;;
            disable)
              echo "ðŸš« Disabling SELinux completely..."
              {
                echo "CONFIG_SECURITY_SELINUX=n"
                echo "CONFIG_SECURITY_SELINUX_DISABLE=y"
                echo "CONFIG_SECURITY_SELINUX_BOOTPARAM=y"
                echo "CONFIG_SECURITY_SELINUX_BOOTPARAM_VALUE=0"
              } >> arch/arm64/configs/${{ env.DEFCONFIG }}
              echo "âœ… SELinux disabled at kernel level."
              ;;
            normal)
              echo "ðŸ”’ Keeping SELinux enforcing (default)."
              ;;
          esac

      - name: Build kernel Image
        run: |
          set -euo pipefail
          cd "${{ env.KERNEL_DIR }}"
          mkdir -p "${OUTDIR}"

          TOOLCHAIN_BIN="${{ env.TOOLCHAIN_DIR }}/bin"

          export ARCH=${{ env.ARCH }}
          export DEFCONFIG=${{ env.DEFCONFIG }}
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CC="${TOOLCHAIN_BIN}/clang"
          export LD="${TOOLCHAIN_BIN}/ld.lld"
          export LLVM=1
          export LLVM_IAS=1

          echo "=== Checking Clang Toolchain ==="
          "${CC}" --version | head -n 3

          echo "=== Generating defconfig: $DEFCONFIG ==="
          make O="${OUTDIR}" ${DEFCONFIG}

          echo "=== Building kernel Image ==="
          make -C . O="${OUTDIR}" -j4 \
            ARCH=${ARCH} \
            CC="${CC}" \
            LD="${LD}" \
            LLVM=1 LLVM_IAS=1 \
            CLANG_TRIPLE=${CLANG_TRIPLE} \
            CROSS_COMPILE=${CROSS_COMPILE} \
            Image

          echo "=== Build finished ==="
          ls -lh "${OUTDIR}/arch/arm64/boot/" || true

          mkdir -p "${{ github.workspace }}/release"
          cp "${OUTDIR}/arch/arm64/boot/Image" "${{ github.workspace }}/release/Image-${GITHUB_RUN_NUMBER}.img"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: |
            Kernel Image #${{ github.run_number }} (${{ github.event.inputs.selinux_mode }})
          tag_name: kernel-${{ github.run_number }}
          body: |
            âœ… Android kernel built with:
            - **AOSP Clang r416183b**
            - **ARCH:** arm64
            - **DEFCONFIG:** mikasa_defconfig
            - **KernelSU Next:** ${{ github.event.inputs.with_kernelsu }}
            - **SELinux mode:** ${{ github.event.inputs.selinux_mode }}
          files: release/*.img
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
